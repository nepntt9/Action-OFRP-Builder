name: Build Batik Recovery Android 12.1 (Fixed)

on:
  workflow_dispatch:
    inputs:
      device_tree:
        description: 'Device Tree Repo'
        required: true
        default: 'https://github.com/nepntt9/0android_device_samsung_m14x'
      device_branch:
        description: 'Device Tree Branch'
        required: true
        default: 'android-12.1'
      maintainer:
        description: 'Maintainer Name'
        required: true
        default: 'YourName'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git repo python3 python3-pip bc bison flex libssl-dev make ccache git-lfs
        
    - name: Configure Git (Fix Auth)
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        git config --global credential.helper store
        
    - name: Setup CCACHE
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 2G
        
    - name: Initialize OrangeFox-12.1 Repo (Stable A12 Alternative)
      run: |
        # Use OrangeFox A12 manifest (stable, no auth issues)
        repo init --depth=1 -u https://github.com/OrangeFoxRecovery/Android -b OrangeFox-12.1
        repo sync -c --force-sync --no-clone-bundle --no-tags -j$(nproc --all) || repo sync -j4
        
    - name: Clone Device Tree
      run: |
        git clone https://${{ github.event.inputs.device_tree }} -b ${{ github.event.inputs.device_branch }} device/samsung/m14x
        
    - name: Setup Environment
      run: |
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        export BR_MAINTAINER="${{ github.event.inputs.maintainer }}"
        . build/envsetup.sh
        
    - name: Lunch Device
      run: |
        lunch twrp_m14x-eng || lunch omni_m14x-eng || echo "Lunch failed, continuing..."
        
    - name: Build Recovery
      run: |
        mka clean || true
        mka recoveryimage -j$(nproc --all) || mka recoveryimage -j4
        
    - name: Package Outputs
      run: |
        RECOVERY_OUT="recovery-${{ github.event.inputs.maintainer }}-m14x-Batik-A12.1.img"
        cp out/target/product/m14x/recovery.img "$RECOVERY_OUT" || cp recovery.img "$RECOVERY_OUT"
        sha256sum "$RECOVERY_OUT" > "$RECOVERY_OUT.sha256"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Batik-m14x-A12.1
        path: |
          recovery-*.img
          *.sha256
        retention-days: 30
