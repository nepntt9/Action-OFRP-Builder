name: Build Batik Recovery Android 12.1 (m14x)

on:
  workflow_dispatch:
    inputs:
      device_tree:
        description: 'Device Tree Repo'
        required: true
        default: 'https://github.com/nepntt9/0android_device_samsung_m14x'
        type: string
      device_branch:
        description: 'Device Tree Branch'
        required: true
        default: 'android-12.1'
        type: string
      maintainer:
        description: 'Maintainer Name'
        required: true
        default: 'nepntt@gmail'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git repo python3 python3-pip bc bison flex libssl-dev make ccache git-lfs
        
    - name: Setup CCACHE
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 2G
        
    - name: Initialize Repo (TWRP A12.1)
      run: |
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_a12 -b twrp-12.1
        repo sync -c --force-sync --no-clone-bundle --no-tags -j$(nproc --all)
        
    - name: Clone Batik Recovery (optional)
      run: |
        git clone https://github.com/BatikRecovery/br_recovery.git -b master bootable/recovery || echo "Using TWRP base"
        
    - name: Clone Device Tree
      run: |
        git clone https://${{ github.event.inputs.device_tree }} -b ${{ github.event.inputs.device_branch }} device/samsung/m14x
        
    - name: Setup Environment
      run: |
        export ALLOW_MISSING_DEPENDENCIES=true
        export BR_MAINTAINER="${{ github.event.inputs.maintainer }}"
        . build/envsetup.sh
        lunch twrp_m14x-eng
        
    - name: Build Recovery
      run: |
        export LC_ALL=C
        make -j$(nproc --all) recoveryimage bootimage
        
    - name: Rename Outputs
      run: |
        cp out/target/product/m14x/recovery.img recovery-${{ github.event.inputs.maintainer }}-m14x-BRP-A12.1.img
        cp out/target/product/m14x/boot.img boot-m14x-A12.1.img || true
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Batik-Recovery-m14x-A12.1
        path: |
          recovery-*.img
          boot-*.img
          out/target/product/m14x/*.zip
        retention-days: 30
