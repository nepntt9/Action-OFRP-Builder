set -e

RED='\u001B[0;31m'
GREEN='\u001B[0;32m'
YELLOW='\u001B[1;33m'
NC='\u001B[0m'

SOURCE_DIR="$HOME/batik_a12"
DEVICE="m14x"
BRANCH="android-12.1"

echo -e "${GREEN}Building Batik Recovery for Android 12.1 ($DEVICE)${NC}"

# Dependencies
sudo apt update && sudo apt install git repo python3 python3-pip bc bison flex libssl-dev make ccache -y

# Clean source
rm -rf "$SOURCE_DIR"
mkdir -p "$SOURCE_DIR"
cd "$SOURCE_DIR"

# Init A12.1-compatible repo (Batik uses old manifest; fallback to TWRP-A12 fork)
echo -e "${YELLOW}Initializing A12.1 repo...${NC}"
repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_a12 -b twrp-12.1
repo sync -c --force-sync -j$(nproc --all)

# Clone Batik recovery (bootable/recovery) if available, else use TWRP base
git clone https://github.com/BatikRecovery/br_recovery.git -b master bootable/recovery || \
echo -e "${YELLOW}Using TWRP base (Batik recovery outdated)${NC}"

# Your m14x device tree (Android 12.1 branch)
DEVICE_TREE="${1:-https://github.com/nepntt9/0android_device_samsung_m14x}"
git clone "$DEVICE_TREE" -b android-12.1 device/samsung/m14x

# Environment
export ALLOW_MISSING_DEPENDENCIES=true
export CCACHE_SIZE="50G"
export CCACHE_DIR="$SOURCE_DIR/.ccache"
. build/envsetup.sh

export BR_MAINTAINER="nepntt@gmail"

# Lunch (TWRP style for A12)
lunch twrp_${DEVICE}-eng

# Build
echo -e "${GREEN}Building for Android 12.1...${NC}"
mka bootimage recoveryimage -j$(nproc --all)

# Outputs
OUT="$SOURCE_DIR/out/target/product/$DEVICE"
echo -e "${GREEN}Done!${NC}"
ls -la "$OUT"/*.img "$OUT"/*.zip

echo -e "${YELLOW}recovery.img ready for Odin.${NC}"
